server {
	listen 8080 default_server;
	root /var/www/html;

	index index.html;

	server_name _;

	location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                resolver 169.254.169.254 valid=2s ipv6=off;
                set $upstream "storage.googleapis.com";
                set $yourbucket "{GCS_BUCKET}";
                rewrite ^/(.*)$ /$yourbucket/$1 break;
                proxy_pass https://$upstream;
                proxy_set_header HOST $upstream;
                proxy_set_header  X-Forwarded-Host  $host;
                proxy_set_header  X-Real-IP         $remote_addr;
                proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header  X-Forwarded-Proto $scheme;
                rewrite_by_lua_block {
                        local file = io.open("/tmp/token")
                        io.input(file)
                        local data = io.read()
                        io.close()
                        ngx.req.set_header("Authorization", "Bearer "..data);
                }
        }

	location /thisistest {
		return 200 "ok";
	}

}
